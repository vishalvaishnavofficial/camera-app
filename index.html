<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Camera App</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
    :root { --accent: #f7d8ba; --bg: #000; --soft-peach: rgba(247, 216, 186, 0.3); }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

    body { background: var(--bg); color: white; margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* Top Bar */
    .top-box { height: 70px; display: flex; align-items: center; justify-content: space-around; z-index: 50; padding: 0 5px; }
    .top-icon-btn { cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #aaa; min-width: 60px; }
    .top-icon-btn span { font-size: 26px; color: white; margin-bottom: 2px; }

    /* Viewport: Fixed Width (100vw), Height changes based on ratio */
    .viewport-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; position: relative; overflow: hidden; }
    
    .viewport { 
        background: #111; 
        position: relative; 
        overflow: hidden; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        width: 100vw; 
        transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .ratio-4-3 { height: calc(100vw * 4 / 3); }
    .ratio-1-1 { height: 100vw; } /* New Square Ratio */
    .ratio-full { height: 100%; }

    #videoFeed { position: absolute; min-width: 100%; min-height: 100%; object-fit: cover; pointer-events: none; }

    /* Controls */
    .controls { padding-bottom: 40px; display: flex; flex-direction: column; align-items: center; background: black; z-index: 50; }
    .mode-container { width: 100%; height: 50px; position: relative; overflow: hidden; margin-bottom: 10px; }
    .mode-track { display: flex; position: absolute; left: 0; top: 50%; transition: transform 0.4s cubic-bezier(0.2, 1, 0.3, 1); will-change: transform; }
    .mode-item { padding: 8px 20px; color: #888; font-size: 13px; white-space: nowrap; text-transform: uppercase; letter-spacing: 1.2px; transition: 0.3s; border-radius: 25px; margin: 0 5px; }
    .mode-item.active { color: var(--accent); background: var(--soft-peach); font-weight: bold; }

    .shutter-row { display: flex; width: 100%; justify-content: space-around; align-items: center; max-width: 420px; }
    .shutter-btn { width: 75px; height: 75px; background: white; border-radius: 50%; border: 4px solid #000; outline: 2px solid white; cursor: pointer; }
    .shutter-btn.recording { background: #ff3b30; border-radius: 15px; }
    .gallery-circle, .rotate-btn { width: 55px; height: 55px; border-radius: 50%; background: #1a1a1a; display: flex; justify-content: center; align-items: center; border: 1px solid #333; cursor: pointer; overflow: hidden; }
    .gallery-circle img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div class="top-box">
    <div class="top-icon-btn" onclick="toggleFlash()"><span id="fIcon" class="material-symbols-outlined">flash_off</span><div>Flash</div></div>
    <div class="top-icon-btn" onclick="toggleTimer()"><span id="tIcon" class="material-symbols-outlined">timer_off</span><div id="tLbl">Timer</div></div>
    <div class="top-icon-btn" onclick="toggleRatio()"><span class="material-symbols-outlined">aspect_ratio</span><div id="rLbl">Full</div></div>
    <div class="top-icon-btn" onclick="document.getElementById('viewport').classList.toggle('grid-active')"><span class="material-symbols-outlined">grid_on</span><div>Grid</div></div>
</div>

<div class="viewport-container">
    <div class="viewport ratio-full" id="viewport">
        <video id="videoFeed" autoplay playsinline muted></video>
    </div>
</div>

<div class="controls">
    <div class="mode-container">
        <div class="mode-track" id="modeTrack">
            <div class="mode-item" onclick="setMode(0, 'video')">Video</div>
            <div class="mode-item active" onclick="setMode(1, 'photo')">Photo</div>
            <div class="mode-item" onclick="setMode(2, 'hdphoto')">HD Pro</div>
        </div>
    </div>
    <div class="shutter-row">
        <div class="gallery-circle" onclick="window.location.href='gallery.html'">
            <img id="thumbImg" style="display:none">
            <span id="galleryIcon" class="material-symbols-outlined" style="color:#666">image</span>
        </div>
        <div class="shutter-btn" id="shutter"></div>
        <div class="rotate-btn" onclick="toggleCamera()"><span class="material-symbols-outlined">autorenew</span></div>
    </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video = document.getElementById('videoFeed');
const modeTrack = document.getElementById('modeTrack');
const shutter = document.getElementById('shutter');
let currentMode = "photo", currentFacing = "environment", mediaRecorder, chunks = [];

async function init() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacing, width: 3840, height: 2160 }, audio: true });
    video.srcObject = stream;
}

function setMode(idx, mode) {
    currentMode = mode;
    const items = document.querySelectorAll('.mode-item');
    items.forEach((item, i) => item.classList.toggle('active', i === idx));
    const offset = (document.querySelector('.mode-container').offsetWidth / 2) - (items[idx].offsetLeft + items[idx].offsetWidth / 2);
    modeTrack.style.transform = `translate(${offset}px, -50%)`;
}

function toggleRatio() {
    const vp = document.getElementById('viewport');
    const lbl = document.getElementById('rLbl');
    if (vp.classList.contains('ratio-full')) { vp.className = 'viewport ratio-4-3'; lbl.innerText = '4:3'; }
    else if (vp.classList.contains('ratio-4-3')) { vp.className = 'viewport ratio-1-1'; lbl.innerText = '1:1'; }
    else { vp.className = 'viewport ratio-full'; lbl.innerText = 'Full'; }
}

shutter.onclick = () => {
    if (currentMode.includes('photo')) capture();
    else if (mediaRecorder?.state === "recording") stopRec();
    else startRec();
};

function saveMedia(dataUrl, type) {
    const gallery = JSON.parse(localStorage.getItem('camera_gallery') || '[]');
    gallery.unshift({ data: dataUrl, type: type, date: Date.now() });
    localStorage.setItem('camera_gallery', JSON.stringify(gallery));
    document.getElementById('thumbImg').src = dataUrl;
    document.getElementById('thumbImg').style.display = 'block';
    document.getElementById('galleryIcon').style.display = 'none';
}

function capture() {
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    saveMedia(canvas.toDataURL('image/jpeg'), 'image');
}

async function startRec() {
    chunks = [];
    mediaRecorder = new MediaRecorder(video.srcObject);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/mp4' });
        const reader = new FileReader();
        reader.onloadend = () => saveMedia(reader.result, 'video');
        reader.readAsDataURL(blob);
    };
    mediaRecorder.start();
    shutter.classList.add('recording');
}

function stopRec() { mediaRecorder.stop(); shutter.classList.remove('recording'); }

function toggleCamera() { currentFacing = currentFacing === "environment" ? "user" : "environment"; init(); }
window.onload = () => { init(); setMode(1, 'photo'); };
</script>
</body>
</html>
